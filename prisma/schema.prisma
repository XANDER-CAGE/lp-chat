generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model file {
  id         String    @id @default(uuid()) @db.VarChar(24)
  bucketName String    @map("bucket_name")
  type       String    @map("type")
  name       String    @map("name")
  size       Int       @map("size")
  createdAt  DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  message    message?

  @@map("file")
}

model message {
  id               String    @id @default(uuid()) @db.VarChar(24)
  content          String?   @map("content")
  fileId           String?   @unique @map("file_id")
  file             file?     @relation(fields: [fileId], references: [id])
  chatId           String    @map("chat_id")
  chat             chat      @relation(fields: [chatId], references: [id])
  repliedMessageId String?   @map("replied_message_id")
  tgMsgId          String?   @map("tg_msg_id")
  authorId         String    @map("author_id")
  author           user      @relation(fields: [authorId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  createdAt        DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt        DateTime? @updatedAt @map("updated_at")
  repliedMessage   message?  @relation("messageTomessage", fields: [repliedMessageId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  repliedMessages  message[] @relation("messageTomessage")

  @@map("message")
}

model rejectedChat {
  id         String    @id @default(uuid()) @db.VarChar(24)
  chatId     String    @map("chat_id")
  chat       chat      @relation(fields: [chatId], references: [id])
  operatorId String    @map("operator_id")
  operator   user      @relation(fields: [operatorId], references: [id])
  createdAt  DateTime? @default(now()) @map("created_at") @db.Timestamp(6)

  @@map("rejected_chat")
}

model rating {
  id        String    @id @default(uuid()) @db.VarChar(24)
  rate      Int       @map("rate")
  message   String    @map("message")
  chatId    String?   @map("chat_id")
  clientId  String?   @map("client_id")
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt DateTime? @updatedAt @map("updated_at")
  chat      chat?     @relation(fields: [chatId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  client    user?     @relation(fields: [clientId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@map("rating")
}

model user {
  id               String            @id @default(uuid()) @db.VarChar(24)
  approvedAt       DateTime?         @map("approved_at")
  blockedAt        DateTime?         @map("blocked_at")
  createdAt        DateTime?         @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt        DateTime?         @updatedAt @map("updated_at")
  shiftStatus      shiftStatus?      @map("shift_status")
  messages         message[]
  telegramId       String?           @unique @map("telegram_id")
  username         String?           @map("username")
  kcUserId         String?           @unique @map("kc_user_id")
  email            String?           @map("email")
  lastname         String?           @map("lastname")
  firstname        String?           @map("firstname")
  phone            String?           @map("phone")
  ratings          rating[]          @ignore
  shift            shift[]
  userChats        chat[]            @relation("clientChats")
  operatorChats    chat[]            @relation("operatorChats")
  messagesToDelete messageToDelete[]
  rejectedChats    rejectedChat[]

  @@map("user")
}

model chat {
  id                String            @id @default(uuid()) @db.VarChar(24)
  topicId           String            @map("topic_id")
  topic             topic             @relation(fields: [topicId], references: [id])
  status            chatstatus        @map("status")
  clientId          String            @map("client_id")
  client            user              @relation("clientChats", fields: [clientId], references: [id])
  operatorId        String?           @map("operator_id")
  operator          user?             @relation("operatorChats", fields: [operatorId], references: [id])
  createdAt         DateTime?         @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt         DateTime?         @updatedAt @map("updated_at")
  messages          message[]
  rating            rating[]
  rejectedOperators rejectedChat[]
  messagesToDelete  messageToDelete[] @ignore

  @@map("chat")
}

model topic {
  id          String    @id @default(uuid()) @db.VarChar(24)
  name        String    @map("name")
  description String?   @map("description")
  createdAt   DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt   DateTime? @updatedAt @map("updated_at")
  chats       chat[]

  @@map("topic")
}

model shift {
  id         String      @id @default(uuid()) @db.VarChar(24)
  status     shiftStatus @map("status")
  operatorId String      @map("operator_id")
  operator   user        @relation(fields: [operatorId], references: [id])
  createdAt  DateTime?   @default(now()) @map("created_at") @db.Timestamp(6)

  @@map("shift")
}

model messageToDelete {
  id          String    @id @default(uuid()) @db.VarChar(24)
  tgMessageId String    @map("tg_message_id")
  operatorId  String    @map("operator_id")
  operator    user      @relation(fields: [operatorId], references: [id])
  chatId      String    @map("chat_id")
  chat        chat      @relation(fields: [chatId], references: [id])
  createdAt   DateTime? @default(now()) @map("created_at") @db.Timestamp(6)

  @@map("message_to_delete")
}

enum chatstatus {
  active
  done
  underInvestigation
  init
}

enum shiftStatus {
  active
  inactive
}
